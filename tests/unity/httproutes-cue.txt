# TODO fix this hack needed to execute from the root
cd ..
# Works, but slowly with evalv3=0
env CUE_EXPERIMENT=embed,evalv3=0
exec cue export --out yaml -e holos --inject ProjectName=network --inject holos_component_name=httproutes --inject holos_component_path=projects/network/components/httproutes --inject holos_component_labels={"component":"httproutes"} ./projects/network/components/httproutes
cmp stdout $WORK/golden.txt

# Does not work with evalv3=1
env CUE_EXPERIMENT=embed,evalv3=1
exec cue export --out yaml -e holos --inject ProjectName=network --inject holos_component_name=httproutes --inject holos_component_path=projects/network/components/httproutes --inject holos_component_labels={"component":"httproutes"} ./projects/network/components/httproutes
cmp stdout $WORK/golden.txt

-- golden.txt --
kind: BuildPlan
apiVersion: v1alpha5
metadata:
  name: httproutes
  labels:
    component: httproutes
spec:
  artifacts:
    - artifact: components/httproutes/httproutes.gen.yaml
      generators:
        - kind: Resources
          output: resources.gen.yaml
          resources:
            HTTPRoute:
              argocd:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: argocd
                  namespace: istio-ingress
                  labels:
                    app: argocd
                spec:
                  hostnames:
                    - argocd.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: argocd-server
                          namespace: argocd
                          port: 80
              kargo:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: kargo
                  namespace: istio-ingress
                  labels:
                    app: kargo
                spec:
                  hostnames:
                    - kargo.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: kargo-api
                          namespace: kargo
                          port: 80
              dev-httpbin:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: dev-httpbin
                  namespace: istio-ingress
                  labels:
                    app: dev-httpbin
                spec:
                  hostnames:
                    - dev-httpbin.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: httpbin
                          namespace: dev-httpbin
                          port: 80
              test-httpbin:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: test-httpbin
                  namespace: istio-ingress
                  labels:
                    app: test-httpbin
                spec:
                  hostnames:
                    - test-httpbin.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: httpbin
                          namespace: test-httpbin
                          port: 80
              uat-httpbin:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: uat-httpbin
                  namespace: istio-ingress
                  labels:
                    app: uat-httpbin
                spec:
                  hostnames:
                    - uat-httpbin.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: httpbin
                          namespace: uat-httpbin
                          port: 80
              httpbin:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: httpbin
                  namespace: istio-ingress
                  labels:
                    app: httpbin
                spec:
                  hostnames:
                    - httpbin.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: httpbin
                          namespace: prod-us-east-httpbin
                          port: 80
                        - name: httpbin
                          namespace: prod-us-central-httpbin
                          port: 80
                        - name: httpbin
                          namespace: prod-us-west-httpbin
                          port: 80
              prod-us-east-httpbin:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: prod-us-east-httpbin
                  namespace: istio-ingress
                  labels:
                    app: prod-us-east-httpbin
                spec:
                  hostnames:
                    - prod-us-east-httpbin.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: httpbin
                          namespace: prod-us-east-httpbin
                          port: 80
              prod-us-central-httpbin:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: prod-us-central-httpbin
                  namespace: istio-ingress
                  labels:
                    app: prod-us-central-httpbin
                spec:
                  hostnames:
                    - prod-us-central-httpbin.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: httpbin
                          namespace: prod-us-central-httpbin
                          port: 80
              prod-us-west-httpbin:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: prod-us-west-httpbin
                  namespace: istio-ingress
                  labels:
                    app: prod-us-west-httpbin
                spec:
                  hostnames:
                    - prod-us-west-httpbin.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: httpbin
                          namespace: prod-us-west-httpbin
                          port: 80
              dev-podinfo:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: dev-podinfo
                  namespace: istio-ingress
                  labels:
                    app: dev-podinfo
                spec:
                  hostnames:
                    - dev-podinfo.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: podinfo
                          namespace: dev-podinfo
                          port: 9898
              test-podinfo:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: test-podinfo
                  namespace: istio-ingress
                  labels:
                    app: test-podinfo
                spec:
                  hostnames:
                    - test-podinfo.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: podinfo
                          namespace: test-podinfo
                          port: 9898
              uat-podinfo:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: uat-podinfo
                  namespace: istio-ingress
                  labels:
                    app: uat-podinfo
                spec:
                  hostnames:
                    - uat-podinfo.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: podinfo
                          namespace: uat-podinfo
                          port: 9898
              podinfo:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: podinfo
                  namespace: istio-ingress
                  labels:
                    app: podinfo
                spec:
                  hostnames:
                    - podinfo.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: podinfo
                          namespace: prod-us-east-podinfo
                          port: 9898
                        - name: podinfo
                          namespace: prod-us-central-podinfo
                          port: 9898
                        - name: podinfo
                          namespace: prod-us-west-podinfo
                          port: 9898
              prod-us-east-podinfo:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: prod-us-east-podinfo
                  namespace: istio-ingress
                  labels:
                    app: prod-us-east-podinfo
                spec:
                  hostnames:
                    - prod-us-east-podinfo.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: podinfo
                          namespace: prod-us-east-podinfo
                          port: 9898
              prod-us-central-podinfo:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: prod-us-central-podinfo
                  namespace: istio-ingress
                  labels:
                    app: prod-us-central-podinfo
                spec:
                  hostnames:
                    - prod-us-central-podinfo.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: podinfo
                          namespace: prod-us-central-podinfo
                          port: 9898
              prod-us-west-podinfo:
                apiVersion: gateway.networking.k8s.io/v1
                kind: HTTPRoute
                metadata:
                  name: prod-us-west-podinfo
                  namespace: istio-ingress
                  labels:
                    app: prod-us-west-podinfo
                spec:
                  hostnames:
                    - prod-us-west-podinfo.holos.localhost
                  parentRefs:
                    - name: default
                      namespace: istio-ingress
                  rules:
                    - matches:
                        - path:
                            type: PathPrefix
                            value: /
                      backendRefs:
                        - name: podinfo
                          namespace: prod-us-west-podinfo
                          port: 9898
      validators: []
      transformers:
        - kind: Kustomize
          inputs:
            - resources.gen.yaml
          output: components/httproutes/httproutes.gen.yaml
          kustomize:
            kustomization:
              labels:
                - includeSelectors: false
                  pairs:
                    argocd.argoproj.io/instance: network-httproutes
              resources:
                - resources.gen.yaml
              kind: Kustomization
              apiVersion: kustomize.config.k8s.io/v1beta1
    - artifact: gitops/httproutes.application.gen.yaml
      generators:
        - kind: Resources
          output: gitops/httproutes.application.gen.yaml
          resources:
            Application:
              network-httproutes:
                apiVersion: argoproj.io/v1alpha1
                kind: Application
                metadata:
                  name: network-httproutes
                  namespace: argocd
                  labels: {}
                spec:
                  destination:
                    server: https://kubernetes.default.svc
                  project: network
                  source:
                    path: deploy/components/httproutes
                    repoURL: https://github.com/holos-run/kargo-demo.git
                    targetRevision: main
